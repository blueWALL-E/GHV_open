function [alpha_star, LDmax, stats] = alpha_opt_LD(M, alpha_lo, alpha_hi)
    % 求给定马赫数 M 下最佳升阻比对应的攻角（单位：度）
    % 输入：M 可以是标量或向量；alpha_lo/alpha_hi 缺省为 [0,12]
    % 输出：
    %   alpha_star  — 最优攻角（度）
    %   LDmax       — 对应的 L/D 最大值
    %   stats       — 结构体，含 CL, CD 以及优化器信息（便于调试）

    if nargin < 2, alpha_lo = 0; end
    if nargin < 3, alpha_hi = 12; end

    M = M(:); % 列向量
    n = numel(M);
    alpha_star = zeros(n, 1);
    LDmax = zeros(n, 1);

    % 目标函数：J = CD/CL（CL<=0 时加罚）
    epsCL = 1e-9;

    function J = obj(alpha_deg, M1)
        CL = aero_CL(alpha_deg, M1);
        CD = aero_CD(alpha_deg, M1);
        pen = 0;

        if CL <= 0
            pen = 1e3 +1e2 * abs(CL);
        end

        J = CD / max(CL, epsCL) + pen;
    end

    opts = optimset('TolX', 1e-4, 'Display', 'off');

    % 批量处理每个 M
    for i = 1:n
        Mi = M(i);

        % --- 1) 粗扫锁定 bracket（更稳） ---
        N = 41; A = linspace(alpha_lo, alpha_hi, N);
        J = arrayfun(@(a) obj(a, Mi), A);
        [~, k] = min(J);
        lo = A(max(1, k - 1)); hi = A(min(N, k + 1));
        if lo == hi, lo = alpha_lo; hi = alpha_hi; end

        % --- 2) 精细化 fminbnd ---
        [a_star, Jmin] = fminbnd(@(a) obj(a, Mi), lo, hi, opts);

        % 记录结果
        cl = aero_CL(a_star, Mi);
        cd = aero_CD(a_star, Mi);
        alpha_star(i) = a_star;
        LDmax(i) = cl / cd;

        if nargout > 2
            stats(i).M = Mi; %#ok<*AGROW>
            stats(i).alpha = a_star;
            stats(i).Jmin = Jmin;
            stats(i).CL = cl;
            stats(i).CD = cd;
        end

    end

end

% ================== 气动模型（舵面取 0） ==================
function CL = aero_CL(ALPHA, M)
    % 舵面取 0：LE=0, RE=0
    LE = 0; RE = 0;

    CLbv = -8.19E-02 ...
        +4.70E-02 .* M ...
        +1.86E-02 .* ALPHA ...
        -4.73E-04 .* (ALPHA .* M) ...
        -9.19E-03 .* M .^ 2 ...
        -1.52E-04 .* ALPHA .^ 2 ...
        +5.99E-07 .* (ALPHA .* M) .^ 2 ...
        +7.74E-04 .* M .^ 3 ...
        +4.08E-06 .* ALPHA .^ 3 ...
        -2.93E-05 .* M .^ 4 ...
        -3.91E-07 .* ALPHA .^ 4 ...
        +4.12E-07 .* M .^ 5 ...
        +1.30E-08 .* ALPHA .^ 5;

    CL_RE = -1.45E-05 ...
        +1.01E-04 .* ALPHA ...
        +7.10E-06 .* M ...
        -4.14E-04 .* RE ...
        -3.51E-06 .* (ALPHA .* RE) ...
        +4.70E-06 .* (ALPHA .* M) ...
        +8.72E-06 .* (M .* RE) ...
        -1.70E-07 .* (ALPHA .* M) .* RE;

    CL_LE = -1.45E-05 ...
        +1.01E-04 .* ALPHA ...
        +7.10E-06 .* M ...
        -4.14E-04 .* LE ...
        -3.51E-06 .* (ALPHA .* LE) ...
        +4.70E-06 .* (ALPHA .* M) ...
        +8.72E-06 .* (M .* LE) ...
        -1.70E-07 .* (ALPHA .* M) .* LE;

    CL = CLbv + CL_RE + CL_LE; % RUD 对 CL 影响未给出，按 0 处理
end

function CD = aero_CD(ALPHA, M)
    LE = 0; RE = 0; RUD = 0;

    CDbv = 8.717E-02 ...
        -3.307E-02 .* M ...
        +3.179E-03 .* ALPHA ...
        -1.250E-04 .* (ALPHA .* M) ...
        +5.036E-03 .* M .^ 2 ...
        -1.100E-03 .* ALPHA .^ 2 ...
        +1.405E-07 .* (ALPHA .* M) .^ 2 ...
        -3.658E-04 .* M .^ 3 ...
        +3.175E-04 .* ALPHA .^ 3 ...
        +1.274E-05 .* M .^ 4 ...
        -2.985E-05 .* ALPHA .^ 4 ...
        -1.705E-07 .* M .^ 5 ...
        +9.766E-07 .* ALPHA .^ 5;

    CD_RE = 4.5548e-004 ...
        +2.5411e-005 .* ALPHA ...
        -1.1436e-004 .* M ...
        -3.6417e-005 .* RE ...
        -5.3015e-007 .* ((ALPHA .* M) .* RE) ...
        +3.2187e-006 .* (ALPHA .^ 2) ...
        +3.0140e-006 .* (M .^ 2) ...
        +6.9629e-006 .* (RE .^ 2) ...
        +2.1026e-012 .* (((ALPHA .* M) .* RE) .^ 2);

    CD_LE = 4.5548e-004 ...
        +2.5411e-005 .* ALPHA ...
        -1.1436e-004 .* M ...
        -3.6417e-005 .* LE ...
        -5.3015e-007 .* ((ALPHA .* M) .* LE) ...
        +3.2187e-006 .* (ALPHA .^ 2) ...
        +3.0140e-006 .* (M .^ 2) ...
        +6.9629e-006 .* (LE .^ 2) ...
        +2.1026e-012 .* (((ALPHA .* M) .* LE) .^ 2);

    CD_RUD = +7.50E-04 ...
        -2.29E-05 .* ALPHA ...
        -9.69E-05 .* M ...
        -1.83E-06 .* RUD ...
        +9.13E-09 .* (ALPHA .* M) .* RUD ...
        +8.76E-07 .* ALPHA .^ 2 ...
        +2.70E-06 .* M .^ 2 ...
        +1.97E-06 .* RUD .^ 2 ...
        -1.77E-11 .* ((ALPHA .* M) .* RUD) .^ 2;

    CD = CDbv + CD_RE + CD_LE + CD_RUD;
end
